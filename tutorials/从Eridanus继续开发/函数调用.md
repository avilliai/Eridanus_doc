---
sidebar_position: 4
---
# å‡½æ•°è°ƒç”¨
æ­¤ç« èŠ‚ä¼šç•¥æœ‰éš¾åº¦ï¼Œè¯·è€å¿ƒé˜…è¯»ã€‚
## pluginsä¸­å®šä¹‰åŸºæœ¬å‡½æ•°
åœ¨pluginsæ–°å»ºä¸€ä¸ªweather_query.pyï¼Œå¹¶å®Œæˆå¯¹åº”å¤©æ°”æŸ¥è¯¢å‡½æ•°
```python
import httpx
from xpinyin import Pinyin
p = Pinyin()
async def weather_query(proxy,api_key,location):
    location = location.replace('å¸‚','')
    location = p.get_pinyin(location, '')

    if proxy is not None and proxy !="":
        proxies={"http://": proxy, "https://": proxy}
    else:
        proxies=None
    async with httpx.AsyncClient(proxies=proxies) as client:
        r = await client.get(f"https://api.seniverse.com/v3/weather/daily.json?key={api_key}&location={location}&language=zh-Hans&unit=c&start=0&days=5")
        data = r.json()
        #print(data)
        return data["results"]
```
## runä¸­å®šä¹‰æ”¶å‘å‡½æ•°
åœ¨runä¸‹åˆ›å»ºä¸€ä¸ªbasic_plugin.pyï¼Œå®ç°å¤©æ°”æŸ¥è¯¢çš„æ”¶å‘ã€‚

æˆ‘ä»¬éœ€è¦**åŒæ—¶è€ƒè™‘ã€æ ¼å¼è§¦å‘ã€‘å’Œã€å‡½æ•°è°ƒç”¨ã€‘ä¸¤ç§æƒ…å†µï¼Œé‚£ä¹ˆæˆ‘è®¤ä¸ºç›®å‰æœ€å¥½çš„å¤„ç†æ–¹å¼æ˜¯è¿™æ ·ã€‚**
```python
from developTools.event.events import GroupMessageEvent
from developTools.message.message_components import Record, Node, Text
from plugins.basic_plugin.weather_query import weather_query
from plugins.core.aiReplyCore_without_funcCall import aiReplyCore_shadow
"""
ä¾›func callè°ƒç”¨
"""
async def call_weather_query(bot,event,config,location):
    

    r=await weather_query(config.api["proxy"]["http_proxy"],config.api["å¿ƒçŸ¥å¤©æ°”"]["api_key"],location)
    r = await aiReplyCore([{"text":f"{r}"}], event.user_id, config,func_result=True)
    await bot.send(event, str(r))
def main(bot,config):
    global avatar
    avatar=False
    @bot.on(GroupMessageEvent)
    async def sendLike(event: GroupMessageEvent):
        if event.raw_message.startswith("æŸ¥å¤©æ°”"):
            location = event.raw_message.split("æŸ¥å¤©æ°”")[1].strip()
            await call_weather_query(bot,event,config,location)
```
å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬å°†call_weather_queryå®šä¹‰åœ¨äº†mainå‡½æ•°å¤–éƒ¨ã€‚è¿™æ˜¯ä¸ºäº†èƒ½å¤Ÿè®©å®ƒè¢«func_map.pyå¯¼å…¥å¹¶è°ƒç”¨ã€‚

è¿™æ˜¯ä¸€æ¡aiReplyCoreä¸­å®šä¹‰çš„è§„åˆ™ï¼š**æ‰€æœ‰æ”¯æŒã€å‡½æ•°è°ƒç”¨ã€‘çš„å‡½æ•°ï¼Œéƒ½å¿…é¡»æ¥å—(bot,event,config)è¿™ä¸‰ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ã€‚**
### ä¸ºå•¥ä¸ç”¨aiReplyCoreè€Œæ˜¯aiReplyCore_shadow
ä¼šå‡ºç°å¾ªç¯å¯¼å…¥çš„æƒ…å†µï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè·å–åˆ°ç»“æœåï¼ŒäºŒæ¬¡ä¸»åŠ¨è°ƒç”¨ä¸ä¼šå†è§¦å‘ã€å‡½æ•°è°ƒç”¨ã€‘ï¼Œä¸ç„¶å¯èƒ½åµŒå¥—æ²¡å®Œæ²¡äº†äº†ã€‚

å¦‚æœä½ çœŸçš„æœ‰è¿™ç§éœ€è¦ã€‚å¯ä»¥åœ¨è°ƒç”¨å‰å¯¼å…¥aiReplyCoreï¼Œè¿™æ ·èƒ½å¿½æ‚ pyè§£é‡Šå™¨ï¼Œå…è®¸ä½ åœ¨è¿è¡Œæ—¶è°ƒç”¨ã€‚

æˆ‘ä»¬åŠ¨æ€ç¼–ç¨‹è¯­è¨€æ˜¯è¿™æ ·çš„ã€‚ğŸ˜‹
### func_resultæ˜¯å¹²å•¥çš„
å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨
```yaml
r = await aiReplyCore_shadow([{"text":f"è¯·ä½ ä¸ºæˆ‘æ’­æŠ¥æ¥ä¸‹æ¥å‡ å¤©çš„å¤©æ°”{r}"}], event.user_id, config)
```
è€Œæ˜¯ä½¿ç”¨äº†ä¸€ä¸ªé¢å¤–çš„å‚æ•°func_result
````yaml
r = await aiReplyCore_shadow([{"text":f"{r}"}], event.user_id, config,func_result=True)
````
å®ƒçš„ä½œç”¨æ˜¯ï¼Œå‘Šè¯‰botï¼Œè¿™æ¬¡çš„æç¤ºè¯ï¼Œæ˜¯å…ˆå‰å‡½æ•°è°ƒç”¨çš„ç»“æœã€‚è¿™å°†ä½¿ä½ çœå»ä¸ºæŸ¥è¯¢åŠŸèƒ½ä¸“é—¨å†™æç¤ºè¯çš„éº»çƒ¦ã€‚
## ç¼–å†™func_map
æ­¤å¤„ä»¥geminiä¸ºä¾‹ï¼Œopenaiæ ‡å‡†åŒç†ï¼Œåªæ˜¯æ–‡ä»¶ä¸åŒ
### åœ¨jsonæ–‡ä»¶ä¸­æ·»åŠ å‡½æ•°
geminiç´¢å¼•ä¸º`plugins/core/gemini_func_call.json`ï¼Œç”¨è®°äº‹æœ¬æ‰“å¼€å®ƒã€‚

åœ¨å·¥å…·åˆ—è¡¨çš„æœ€åæ·»åŠ æˆ‘ä»¬åˆšåˆšå®šä¹‰çš„call_weather_queryã€‚

**è¯·åŠ¡å¿…æ³¨æ„jsonæ ¼å¼**ã€‚
```json
{
  "function_declarations": [
    {
      "name": "call_user_data_register",
      "description": "åœ¨æ•°æ®åº“ä¸­æ³¨å†Œç”¨æˆ·"
    },
    {
      "name": "call_user_data_query",
      "description": "æŸ¥è¯¢ç”¨æˆ·æ•°æ®ã€‚eg.æƒé™ç­‰çº§ç­‰å†…å®¹ã€‚"
    },
    {
      "name": "call_user_data_sign",
      "description": "ç­¾åˆ°ã€‚å®ç°ç­¾åˆ°è¡Œä¸ºã€‚"
    },
    {
      "name": "call_change_name",
      "description": "ä¿®æ”¹å¯¹ç”¨æˆ·çš„ç§°å‘¼ã€ç§°è°“ã€‚",
      "parameters": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "description": "ç”¨æˆ·æ˜µç§°ã€‚"
          }
        },
        "required": [
          "name"
        ]
      }
    },
    {
      "name": "call_weather_query",
      "description": "Get the current weather in a given location.",
      "parameters": {
        "type": "object",
        "properties": {
          "location": {
            "type": "string",
            "description": "The city and state, e.g. ä¸Šæµ·"
          }
        },
        "required": [
          "location"
        ]
      }
    }
  ]
}
```
### åœ¨func_map.pyä¸­å¯¼å…¥
æ‰“å¼€plugins/func_map.py

åœ¨æ–‡ä»¶å¼€å¤´å¯¼å…¥åˆšåˆšå®šä¹‰çš„call_weather_query
```python
#ä¸ºfunc_callingæä¾›å‡½æ•°æ˜ å°„
import inspect
import json

from run.user_data import call_user_data_register,call_user_data_query,call_user_data_sign,call_change_city,call_change_name,call_permit
from run.resource_search import search_book_info
from run.basic_plugin import call_weather_query

async def call_func(bot,event,config,func_name, params):
    .........
```
## åœ¨ä¸»å‡½æ•°ä¸­å¯¼å…¥
ç¤ºä¾‹ä¸­çš„å¤©æ°”æŸ¥è¯¢ä½¿ç”¨çš„æ˜¯å¿ƒçŸ¥å¤©æ°”ï¼Œå› æ­¤ä½ éœ€è¦é…ç½®config/api.yaml
```yaml
å¿ƒçŸ¥å¤©æ°”:
  api_key: "" #https://www.seniverse.com/ ç”³è¯·åï¼Œå¡«ç§é’¥
```
ç¤ºä¾‹ä¸­ä½¿ç”¨çš„æ¨¡å‹ä¸ºgeminiï¼Œé…ç½®çš„jsonæ–‡ä»¶ä¹Ÿä¸ºgeminiçš„ï¼Œopenaiæ ‡å‡†æ¥å£è¯·æŒ‰ç…§openaiæ ‡å‡†ç¼–å†™jsonæ–‡ä»¶ã€‚

ä¸è¦å¿˜äº†æ‰“å¼€ã€å‡½æ•°è°ƒç”¨ã€‘å¼€å…³ã€‚

ä¸è¦å¿˜äº†åœ¨ä¸»å‡½æ•°ä¸­å¯¼å…¥ä½ åœ¨runä¸‹å®šä¹‰çš„å‡½æ•°
```python


from plugins.core.yamlLoader import YAMLManager
from run import example, aiReply, user_data, resource_search, basic_plugin

config = YAMLManager(["config/basic_config.yaml","config/api.yaml","config/controller.yaml"]) #è¿™ç©æ„ç”¨æ¥åŠ¨æ€åŠ è½½å’Œä¿®æ”¹é…ç½®æ–‡ä»¶

#from developTools.adapters.http_adapter import HTTPBot
#bot = HTTPBot(http_sever=config.basic_config["adapter"]["http_client"]["url"],access_token=config.basic_config["adapter"]["access_token"],host=str(config.basic_config['adapter']["http_sever"]["host"]), port=int(config.basic_config["adapter"]["http_sever"]["port"]))
#æˆ–è€…ä½¿ç”¨wsé€‚é…å™¨
from developTools.adapters.websocket_adapter import WebSocketBot
bot = WebSocketBot(config.basic_config["adapter"]["ws_client"]["ws_link"])

basic_plugin.main(bot,config) #åŠ è½½basic_pluginæ’ä»¶
#resource_search.main(bot,config) #åŠ è½½èµ„æºæœç´¢æ’ä»¶
aiReply.main(bot,config) #åŠ è½½aiå›å¤æ’ä»¶
#user_data.main(bot,config)
#example.main(bot,config)

bot.run() 


```