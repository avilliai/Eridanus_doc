---
sidebar_position: 4
---
# 函数调用
此章节会略有难度，请耐心阅读。
## plugins中定义基本函数
在plugins新建一个weather_query.py，并完成对应天气查询函数
```python
import httpx
from xpinyin import Pinyin
p = Pinyin()
async def weather_query(proxy,api_key,location):
    location = location.replace('市','')
    location = p.get_pinyin(location, '')

    if proxy is not None and proxy !="":
        proxies={"http://": proxy, "https://": proxy}
    else:
        proxies=None
    async with httpx.AsyncClient(proxies=proxies) as client:
        r = await client.get(f"https://api.seniverse.com/v3/weather/daily.json?key={api_key}&location={location}&language=zh-Hans&unit=c&start=0&days=5")
        data = r.json()
        #print(data)
        return data["results"]
```
## run中定义收发函数
在run下创建一个basic_plugin.py，实现天气查询的收发。

我们需要**同时考虑【格式触发】和【函数调用】两种情况，那么我认为目前最好的处理方式是这样。**
```python
from developTools.event.events import GroupMessageEvent
from developTools.message.message_components import Record, Node, Text
from plugins.basic_plugin.weather_query import weather_query
from plugins.core.aiReplyCore_without_funcCall import aiReplyCore_shadow
"""
供func call调用
"""
async def call_weather_query(bot,event,config,location):
    

    r=await weather_query(config.api["proxy"]["http_proxy"],config.api["心知天气"]["api_key"],location)
    """
    在获取到天气查询的结果后，我们可以采取以下几种处理方式。
    """
    #1.直接返回结果
    #await bot.send(event, str(r)) #不算美观，但方便调试
    #2.使用aiReplyCore_shadow函数处理结果，让ai总结
    #r = await aiReplyCore([{"text":f"{r}"}], event.user_id, config,func_result=True)
    #await bot.send(event, str(r))
    #3.直接返回让调用它的模型判断(推荐)，同样是ai总结，但这是更加明智的做法
    return  {"result": r}
    
    
def main(bot,config):
    global avatar
    avatar=False
    @bot.on(GroupMessageEvent)
    async def sendLike(event: GroupMessageEvent):
        if event.raw_message.startswith("查天气"):
            location = event.raw_message.split("查天气")[1].strip()
            r=await call_weather_query(bot,event,config,location)
            await bot.send(event, r) #这里返回的是原始数据。
```
如你所见，我们将call_weather_query定义在了main函数外部。这是为了能够让它被func_map.py导入并调用。

这是一条aiReplyCore中定义的规则：**所有支持【函数调用】的函数，都必须接受(bot,event,config)这三个对象作为参数。**

## 编写func_map
此处以gemini为例，openai标准同理，只是文件不同
### 在json文件中添加函数
gemini索引为`plugins/core/gemini_func_call.json`，用记事本打开它。

在工具列表的最后添加我们刚刚定义的call_weather_query。

**请务必注意json格式**。
```json
{
  "function_declarations": [
    {
      "name": "call_user_data_register",
      "description": "在数据库中注册用户"
    },
    {
      "name": "call_weather_query",
      "description": "Get the current weather in a given location.",
      "parameters": {
        "type": "object",
        "properties": {
          "location": {
            "type": "string",
            "description": "The city and state, e.g. 上海"
          }
        },
        "required": [
          "location"
        ]
      }
    }
  ]
}
```
### 在func_map.py中导入
打开plugins/func_map.py

在文件开头导入刚刚定义的call_weather_query
```python
#为func_calling提供函数映射
import inspect
import json

from run.user_data import call_user_data_register,call_user_data_query,call_user_data_sign,call_change_city,call_change_name,call_permit
from run.resource_search import search_book_info
from run.basic_plugin import call_weather_query

async def call_func(bot,event,config,func_name, params):
    .........
```
## 在主函数中导入
示例中的天气查询使用的是心知天气，因此你需要配置config/api.yaml
```yaml
心知天气:
  api_key: "" #https://www.seniverse.com/ 申请后，填私钥
```
示例中使用的模型为gemini，配置的json文件也为gemini的，你可以使用`tool.py`将gemini的func.json文件转为openai的func.json文件。

不要忘了打开【函数调用】开关。

不要忘了在主函数中导入你在run下定义的函数
```python


from plugins.core.yamlLoader import YAMLManager
from run import example, aiReply, user_data, resource_search, basic_plugin

config = YAMLManager(["config/basic_config.yaml","config/api.yaml","config/controller.yaml"]) #这玩意用来动态加载和修改配置文件

#from developTools.adapters.http_adapter import HTTPBot
#bot = HTTPBot(http_sever=config.basic_config["adapter"]["http_client"]["url"],access_token=config.basic_config["adapter"]["access_token"],host=str(config.basic_config['adapter']["http_sever"]["host"]), port=int(config.basic_config["adapter"]["http_sever"]["port"]))
#或者使用ws适配器
from developTools.adapters.websocket_adapter import WebSocketBot
bot = WebSocketBot(config.basic_config["adapter"]["ws_client"]["ws_link"])

basic_plugin.main(bot,config) #加载basic_plugin插件
#resource_search.main(bot,config) #加载资源搜索插件
aiReply.main(bot,config) #加载ai回复插件
#user_data.main(bot,config)
#example.main(bot,config)

bot.run() 


```